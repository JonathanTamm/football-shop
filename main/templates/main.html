{% extends 'base.html' %}
{% load static %}

{% block title %}Football Shop{% endblock %}

{% block content %}
<div class="w-full pt-6 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header Section -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-white mb-2">Latest Football Product</h1>
      <p class="text-gray-400">Stay updated with the latest football stories and analysis</p>

      <!-- Button to open modal (AJAX create) -->
      <div class="mt-4">
        <button onclick="showModal()" class="inline-flex items-center px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition-colors">
          Create Product by AJAX
        </button>
      </div>
    </div>

    <!-- Filter + actions -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-gray-800 rounded-lg border border-gray-700 p-4">
      <div class="flex space-x-3 mb-4 sm:mb-0">
        <a href="?" class="{% if request.GET.filter == 'all' or not request.GET.filter  %} bg-green-600 text-white{% else %}bg-gray-900 text-gray-300 border border-gray-700{% endif %} px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white" id="filter-all">
          All Product
        </a>
        <a href="?filter=my" class="{% if request.GET.filter == 'my' %} bg-green-600 text-white{% else %}bg-gray-900 text-gray-300 border border-gray-700{% endif %} px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white" id="filter-my">
          My Product
        </a>
      </div>

      <div class="flex items-center gap-3">
        <!-- Refresh button -->
        <button id="refreshBtn" type="button" class="inline-flex items-center px-3 py-2 bg-gray-900 text-gray-200 border border-gray-700 rounded-md hover:bg-gray-800 transition-colors" title="Refresh products">
          ⟳ Refresh
        </button>

        {% if user.is_authenticated %}
          <div class="text-sm text-gray-400">
            Last login: {{ last_login }}
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Loading / Error / Empty / Grid (JS will toggle) -->
    <div id="loading" class="hidden bg-gray-800 rounded-lg border border-gray-700 p-8 text-center">
      <div class="animate-spin inline-block w-8 h-8 border-4 border-t-green-500 border-gray-600 rounded-full mb-4"></div>
      <div class="text-gray-300">Loading products…</div>
    </div>

    <div id="error" class="hidden bg-gray-800 rounded-lg border border-red-700 p-6 text-center">
      <div class="text-red-300 font-semibold mb-2">Failed to load products</div>
      <div class="text-gray-400 mb-4">Check your connection or try again.</div>
      <div><button id="retryLoad" class="px-4 py-2 bg-red-600 text-white rounded-md">Retry</button></div>
    </div>

    <div id="empty" class="hidden bg-gray-800 rounded-lg border border-gray-700 p-12 text-center">
      <div class="w-32 h-32 mx-auto mb-4">
        <img src="{% static 'image/no-product.png' %}" alt="No product available" class="w-full h-full object-contain">
      </div>
      <h3 class="text-lg font-medium text-white mb-2">No product found</h3>
      <p class="text-gray-400 mb-6">Be the first to share football product with the community.</p>
      <div class="flex justify-center gap-3">
        <button onclick="showModal()" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
          Create Product
        </button>
        <button id="refreshEmpty" class="px-4 py-2 bg-gray-900 text-gray-200 border border-gray-700 rounded-md hover:bg-gray-800">Refresh</button>
      </div>
    </div>

    <div id="grid" class="{% if product_list %}grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6{% else %}hidden{% endif %}">
      {% for product in product_list %}
        {% include 'card_product.html' with product=product %}
      {% endfor %}
    </div>
  </div>
</div>

<script>
(function () {
  // Configuration
  const PRODUCTS_API = "{% url 'main:show_json' %}";
  const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

  // DOM
  const loadingEl = document.getElementById('loading');
  const errorEl = document.getElementById('error');
  const emptyEl = document.getElementById('empty');
  const gridEl = document.getElementById('grid');
  const btnAll = document.getElementById('filter-all');
  const btnMy = document.getElementById('filter-my');

  let activeFilter = 'all';
  let allProducts = [];

  function formatRupiah(value) {
    const n = Number(value) || 0;
    return 'Rp ' + n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  function updateFilterButtons() {
    if (!btnAll || !btnMy) return;
    if (activeFilter === 'all') {
      btnAll.className = 'bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white';
      btnMy.className = 'bg-gray-900 text-gray-300 border border-gray-700 px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white';
    } else {
      btnMy.className = 'bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white';
      btnAll.className = 'bg-gray-900 text-gray-300 border border-gray-700 px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white';
    }
  }

  function showSection({ loading=false, error=false, empty=false, grid=false }) {
    if (loadingEl) loadingEl.classList.toggle('hidden', !loading);
    if (errorEl) errorEl.classList.toggle('hidden', !error);
    if (emptyEl) emptyEl.classList.toggle('hidden', !empty);
    if (gridEl) gridEl.classList.toggle('hidden', !grid);
    if (grid && gridEl) gridEl.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
  }

  function getCategoryLabel(code) {
    const map = {
      jersey: 'Jersey', sepatu: 'Sepatu', bola: 'Bola',
      aksesoris: 'Aksesoris', peralatan: 'Peralatan', koleksi: 'Koleksi'
    };
    return map[code] || code;
  }

  function buildProductCardElement(item) {
    const article = document.createElement('article');
    article.className = 'bg-gray-900 text-white rounded-xl border border-gray-700 hover:shadow-2xl hover:shadow-green-700/20 transition-shadow duration-300 overflow-hidden flex flex-col h-full';

    // safe values
    const name = item.name || '';
    const description = item.description || '';
    const category = item.category || '';
    const thumbnail = item.thumbnail || '';
    const createdAt = item.created_at ? new Date(item.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '';
    const views = Number(item.product_views || 0);
    const isFeatured = !!item.is_featured;
    const isHot = views > 20;
    const canEdit = CURRENT_USER_ID && String(CURRENT_USER_ID) === String(item.user_id);

    // top (thumbnail + badges)
    const top = document.createElement('div');
    top.className = 'relative overflow-hidden bg-gray-800 flex items-center justify-center p-4';

    if (thumbnail) {
      const img = document.createElement('img');
      img.className = 'w-full h-auto max-h-56 object-contain rounded-md shadow-sm mx-auto';
      // set src via property (prevents injection)
      img.src = DOMPurify.sanitize(thumbnail, {ALLOWED_URI_REGEXP: /.*/});
      // alt set safely via textContent -> attribute value (no HTML parsing)
      img.alt = DOMPurify.sanitize(name);
      top.appendChild(img);
    } else {
      const placeholder = document.createElement('div');
      placeholder.className = 'w-full h-56 bg-gray-700 rounded-md';
      top.appendChild(placeholder);
    }

    const leftBadge = document.createElement('div');
    leftBadge.className = 'absolute top-3 left-3';
    const catSpan = document.createElement('span');
    catSpan.className = 'inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-green-600 text-white';
    catSpan.textContent = DOMPurify.sanitize(getCategoryLabel(category));
    leftBadge.appendChild(catSpan);
    top.appendChild(leftBadge);

    const rightBadges = document.createElement('div');
    rightBadges.className = 'absolute top-3 right-3 flex space-x-2';
    if (isFeatured) {
      const f = document.createElement('span');
      f.className = 'inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium bg-yellow-100 text-yellow-800';
      f.textContent = 'Featured';
      rightBadges.appendChild(f);
    }
    if (isHot) {
      const h = document.createElement('span');
      h.className = 'inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium bg-red-100 text-red-800';
      h.textContent = 'Hot';
      rightBadges.appendChild(h);
    }
    top.appendChild(rightBadges);

    // body
    const body = document.createElement('div');
    body.className = 'p-4 flex-1 flex flex-col';

    const metaRow = document.createElement('div');
    metaRow.className = 'flex items-center text-sm text-gray-400 gap-4 mb-3';
    const ttime = document.createElement('time');
    ttime.textContent = createdAt;
    metaRow.appendChild(ttime);
    const sep = document.createElement('span');
    sep.textContent = '•';
    metaRow.appendChild(sep);
    const vspan = document.createElement('span');
    vspan.textContent = `${views} views`;
    metaRow.appendChild(vspan);
    body.appendChild(metaRow);

    const titleH3 = document.createElement('h3');
    titleH3.className = 'text-xl font-semibold text-white mb-2 line-clamp-2';
    const titleA = document.createElement('a');
    titleA.href = `{% url 'main:show_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);
    titleA.className = 'hover:text-green-400 transition-colors';
    titleA.textContent = DOMPurify.sanitize(name);
    titleH3.appendChild(titleA);
    body.appendChild(titleH3);

    // create description element safely (use textContent — prevents HTML execution)
    const descP = document.createElement('p');
    descP.className = 'text-gray-300 text-sm leading-relaxed mb-4 line-clamp-3';
    descP.textContent = description || '';
    body.appendChild(descP);
    
    const footerRow = document.createElement('div');
    footerRow.className = 'mt-auto flex items-center justify-between';
    const priceDiv = document.createElement('div');
    priceDiv.className = 'text-green-400 font-medium';
    priceDiv.textContent = (typeof formatRupiah === 'function') ? formatRupiah(item.price) : ('Rp ' + (Number(item.price) || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."));
    footerRow.appendChild(priceDiv);

    if (canEdit) {
      const edDiv = document.createElement('div');
      edDiv.className = 'text-sm';
      const editA = document.createElement('a');
      editA.href = `{% url 'main:edit_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);
      editA.className = 'text-gray-400 hover:text-gray-200 mr-4';
      editA.textContent = 'Edit';
      const delA = document.createElement('a');
      delA.href = `{% url 'main:delete_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);
      delA.className = 'text-red-500 hover:underline';
      delA.textContent = 'Delete';
      edDiv.appendChild(editA);
      edDiv.appendChild(delA);
      footerRow.appendChild(edDiv);
    }

    body.appendChild(footerRow);

    // assemble
    article.appendChild(top);
    article.appendChild(body);

    return article;
  }

  function renderProducts(products) {
    if (!gridEl) return;
    gridEl.innerHTML = '';
    products.forEach(p => {
      const card = buildProductCardElement(p);
      gridEl.appendChild(card);
    });
  }

  async function fetchProducts(filter='all') {
    showSection({ loading: true });
    try {
      const response = await fetch(`${PRODUCTS_API}?filter=${filter}`, { credentials: 'same-origin' });
      if (!response.ok) throw new Error('Network response was not ok');
      const data = await response.json();

      // Accept either an array (old API) or { products: [...] } (future)
      if (Array.isArray(data)) {
        allProducts = data;
      } else if (data && Array.isArray(data.products)) {
        allProducts = data.products;
      } else {
        allProducts = [];
      }

      const toRender = activeFilter === 'all'
        ? allProducts
        : allProducts.filter(p => String(p.user_id) === String(CURRENT_USER_ID));

      if (!toRender.length) {
        showSection({ empty: true });
      } else {
        renderProducts(toRender);
        showSection({ grid: true });
      }
    } catch (error) {
      console.error('Error fetching products:', error);
      showSection({ error: true });
    }
  }

  // expose helper so modal/other scripts can refresh the list
  window.fetchProductsFromServer = function(filter) {
    fetchProducts(filter || activeFilter || 'all');
  };

  // filter buttons
  btnAll && btnAll.addEventListener('click', (e) => {
    e && e.preventDefault();
    activeFilter = 'all';
    updateFilterButtons();
    renderProducts(allProducts);
  });

  btnMy && btnMy.addEventListener('click', (e) => {
    e && e.preventDefault();
    activeFilter = 'my';
    updateFilterButtons();
    const filteredProducts = allProducts.filter(p => String(p.user_id) === String(CURRENT_USER_ID));
    renderProducts(filteredProducts);
  });

  // wire refresh buttons and retry
  document.getElementById('refreshBtn')?.addEventListener('click', function () {
    if (typeof window.fetchProductsFromServer === 'function') window.fetchProductsFromServer();
  });
  document.getElementById('refreshEmpty')?.addEventListener('click', function () {
    if (typeof window.fetchProductsFromServer === 'function') window.fetchProductsFromServer();
  });
  document.getElementById('retryLoad')?.addEventListener('click', function () {
    if (typeof window.fetchProductsFromServer === 'function') window.fetchProductsFromServer();
  });

  // initial load
  fetchProducts();
})();
</script>

<!-- listen for productAdded events dispatched after AJAX create -->
<script>
document.addEventListener('productAdded', function () {
  if (typeof window.fetchProductsFromServer === 'function') {
    window.fetchProductsFromServer();
  } else {
    location.reload();
  }
});
</script>
{% endblock %}
